name: ğŸ“… Daily YouTube Shorts Automation - FIXED

on:
  workflow_dispatch:

jobs:
  test-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ¬ Setup FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg imagemagick
    
    - name: ğŸ“¦ Install Python Dependencies (FIXED VERSIONS)
      run: |
        python -m pip install --upgrade pip
        pip install google-generativeai==0.3.2
        pip install groq==0.5.0
        pip install openai==0.28.1
        pip install moviepy==1.0.3
        pip install Pillow==10.2.0
        pip install gTTS==2.4.0
        pip install elevenlabs==0.2.27
        pip install google-api-python-client==2.108.0
        pip install google-auth-httplib2==0.1.1
        pip install google-auth-oauthlib==1.1.0
        pip install oauth2client==4.1.3
        pip install requests==2.31.0
        pip install pytz==2024.1
    
    - name: ğŸ§ª Run Basic Tests
      env:
        YT_CLIENT_ID_1: ${{ secrets.YT_CLIENT_ID_1 }}
        YT_CLIENT_SECRET_1: ${{ secrets.YT_CLIENT_SECRET_1 }}
        YT_REFRESH_TOKEN_1: ${{ secrets.YT_REFRESH_TOKEN_1 }}
        YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        python test_simple.py
    
    - name: ğŸ¬ Create Test Video
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ø¨Ø³ÙŠØ· Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        mkdir -p videos/shorts
        ffmpeg -f lavfi -i color=c=blue:s=1080x1920:d=10 -vf "drawtext=text='YouTube Short Test':fontcolor=white:fontsize=72:x=(w-text_w)/2:y=(h-text_h)/2" -c:v libx264 -t 10 -pix_fmt yuv420p videos/shorts/test_video.mp4
        echo "âœ… Test video created"
        ls -la videos/shorts/
    
    - name: ğŸš€ Upload Test Video
      env:
        YT_CLIENT_ID_1: ${{ secrets.YT_CLIENT_ID_1 }}
        YT_CLIENT_SECRET_1: ${{ secrets.YT_CLIENT_SECRET_1 }}
        YT_REFRESH_TOKEN_1: ${{ secrets.YT_REFRESH_TOKEN_1 }}
        YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}
      run: |
        echo "ğŸš€ Starting YouTube upload test..."
        
        cat > upload_test.py << 'EOF'
        import os
        from google.oauth2.credentials import Credentials
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        from google.auth.transport.requests import Request
        
        # Authenticate
        credentials = Credentials(
            token=None,
            refresh_token=os.environ.get('YT_REFRESH_TOKEN_1'),
            token_uri='https://oauth2.googleapis.com/token',
            client_id=os.environ.get('YT_CLIENT_ID_1'),
            client_secret=os.environ.get('YT_CLIENT_SECRET_1'),
            scopes=['https://www.googleapis.com/auth/youtube.upload']
        )
        
        if credentials.expired:
            credentials.refresh(Request())
        
        youtube = build('youtube', 'v3', credentials=credentials)
        print("âœ… YouTube service created")
        
        # Upload video
        request_body = {
            'snippet': {
                'title': 'Test Short - Automation System âœ…',
                'description': 'Testing the YouTube automation system\n\n#shorts #test #automation',
                'tags': ['test', 'automation', 'github', 'shorts'],
                'categoryId': '22'
            },
            'status': {
                'privacyStatus': 'private',
                'selfDeclaredMadeForKids': False
            }
        }
        
        media = MediaFileUpload(
            'videos/shorts/test_video.mp4',
            mimetype='video/mp4',
            resumable=True
        )
        
        print("ğŸ“¤ Uploading video...")
        response = youtube.videos().insert(
            part='snippet,status',
            body=request_body,
            media_body=media
        ).execute()
        
        video_id = response['id']
        video_url = f"https://www.youtube.com/watch?v={video_id}"
        
        print(f"âœ… UPLOAD SUCCESSFUL!")
        print(f"ğŸ¬ Video ID: {video_id}")
        print(f"ğŸ”— Video URL: {video_url}")
        
        # Save result
        with open('upload_result.txt', 'w') as f:
            f.write(f"Success: True\\n")
            f.write(f"Video ID: {video_id}\\n")
            f.write(f"Video URL: {video_url}\\n")
        EOF
        
        python upload_test.py
    
    - name: ğŸ“ Save Results
      if: always()
      run: |
        echo "# ğŸ¬ YouTube Upload Test Results" > upload_summary.md
        echo "" >> upload_summary.md
        echo "**Date:** $(date)" >> upload_summary.md
        echo "" >> upload_summary.md
        
        if [ -f "upload_result.txt" ]; then
          echo "## âœ… Upload Successful" >> upload_summary.md
          echo "" >> upload_summary.md
          cat upload_result.txt >> upload_summary.md
        else
          echo "## âŒ Upload Failed" >> upload_summary.md
          echo "" >> upload_summary.md
          echo "Check the logs above for errors." >> upload_summary.md
        fi
        
        echo "" >> upload_summary.md
        echo "---" >> upload_summary.md
        echo "*Generated by YouTube Automation System*" >> upload_summary.md
        
        cat upload_summary.md
